CREATE DATABASE IF NOT EXISTS sistema_envios;
USE sistema_envios;

-- 1. Tablas independientes (no dependen de otras)
CREATE TABLE USUARIO (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    tipo_usuario VARCHAR(20) NOT NULL,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    ultimo_acceso DATETIME,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE TIPO_CLIENTE (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(50) UNIQUE NOT NULL,
    descripcion VARCHAR(255),
    descuento_default DECIMAL(5,2) DEFAULT 0,
    credito_limite DECIMAL(10,2) DEFAULT 0,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE PUESTO_EMPLEADO (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(50) UNIQUE NOT NULL,
    descripcion VARCHAR(255),
    salario_base DECIMAL(10,2) NOT NULL,
    permisos_json TEXT,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE VEHICULO (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    placas VARCHAR(15) UNIQUE NOT NULL,
    marca VARCHAR(50) NOT NULL,
    modelo VARCHAR(50) NOT NULL,
    capacidad_carga DECIMAL(8,2),
    disponible BOOLEAN DEFAULT TRUE,
    activo BOOLEAN DEFAULT TRUE
);

-- 2. Tablas que dependen de las anteriores
CREATE TABLE CLIENTE (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    usuario_id BIGINT UNIQUE,
    codigo_cliente VARCHAR(20) UNIQUE NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    apellidos VARCHAR(100) NOT NULL,
    telefono VARCHAR(20),
    tipo_cliente_id INT,
    credito_disponible DECIMAL(10,2) DEFAULT 0,
    descuento_asignado DECIMAL(5,2) DEFAULT 0,
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (usuario_id) REFERENCES USUARIO(id),
    FOREIGN KEY (tipo_cliente_id) REFERENCES TIPO_CLIENTE(id)
);

CREATE TABLE EMPLEADO (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    usuario_id BIGINT UNIQUE,
    numero_empleado VARCHAR(20) UNIQUE NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    apellidos VARCHAR(100) NOT NULL,
    telefono VARCHAR(20),
    salario_actual DECIMAL(10,2) NOT NULL,
    fecha_ingreso DATE NOT NULL,
    tienda_id BIGINT,
    supervisor_id BIGINT,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (usuario_id) REFERENCES USUARIO(id),
    FOREIGN KEY (supervisor_id) REFERENCES EMPLEADO(id)
);

CREATE TABLE REPARTIDOR_INFO (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    empleado_id BIGINT UNIQUE NOT NULL,
    licencia_conducir VARCHAR(20) UNIQUE NOT NULL,
    disponible BOOLEAN DEFAULT TRUE,
    calificacion_promedio DECIMAL(3,2) DEFAULT 0,
    latitud_actual DECIMAL(10,8),
    longitud_actual DECIMAL(11,8),
    fecha_actualizacion_ubicacion DATETIME,
    FOREIGN KEY (empleado_id) REFERENCES EMPLEADO(id)
);

CREATE TABLE TIENDA (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    codigo_tienda VARCHAR(20) UNIQUE NOT NULL,
    nombre_tienda VARCHAR(100) NOT NULL,
    direccion_completa TEXT NOT NULL,
    telefono VARCHAR(20),
    email VARCHAR(100),
    gerente_id BIGINT,
    horario_apertura TIME,
    horario_cierre TIME,
    capacidad_almacen INT,
    activa BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (gerente_id) REFERENCES EMPLEADO(id)
);

-- 3. Tablas de relación muchos-a-muchos
CREATE TABLE EMPLEADO_PUESTO (
    empleado_id BIGINT,
    puesto_id INT,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_fin DATETIME,
    activo BOOLEAN DEFAULT TRUE,
    PRIMARY KEY (empleado_id, puesto_id),
    FOREIGN KEY (empleado_id) REFERENCES EMPLEADO(id),
    FOREIGN KEY (puesto_id) REFERENCES PUESTO_EMPLEADO(id)
);

CREATE TABLE REPARTIDOR_VEHICULO (
    repartidor_id BIGINT,
    vehiculo_id BIGINT,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_fin DATETIME,
    PRIMARY KEY (repartidor_id, vehiculo_id, fecha_asignacion),
    FOREIGN KEY (repartidor_id) REFERENCES REPARTIDOR_INFO(id),
    FOREIGN KEY (vehiculo_id) REFERENCES VEHICULO(id)
);

-- 4. Tablas que dependen de cliente/empleado/repartidor/tienda
CREATE TABLE ZONA (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    codigo_zona VARCHAR(20) UNIQUE NOT NULL,
    nombre_zona VARCHAR(100) NOT NULL,
    descripcion TEXT,
    tarifa_base DECIMAL(8,2) NOT NULL,
    tiempo_entrega_estimado INT,
    tienda_responsable_id BIGINT,
    activa BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (tienda_responsable_id) REFERENCES TIENDA(id)
);

CREATE TABLE ZONA_REPARTIDOR (
    zona_id BIGINT,
    repartidor_id BIGINT,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE,
    PRIMARY KEY (zona_id, repartidor_id),
    FOREIGN KEY (zona_id) REFERENCES ZONA(id),
    FOREIGN KEY (repartidor_id) REFERENCES REPARTIDOR_INFO(id)
);

CREATE TABLE PAQUETE (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    codigo_paquete VARCHAR(20) UNIQUE NOT NULL,
    descripcion TEXT,
    peso DECIMAL(8,2) NOT NULL,
    largo DECIMAL(8,2),
    ancho DECIMAL(8,2),
    alto DECIMAL(8,2),
    tipo_contenido VARCHAR(50),
    fragil BOOLEAN DEFAULT FALSE,
    valor_declarado DECIMAL(10,2),
    requiere_seguro BOOLEAN DEFAULT FALSE,
    observaciones TEXT,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE ENVIO (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    numero_seguimiento VARCHAR(30) UNIQUE NOT NULL,
    remitente_id BIGINT NOT NULL,
    destinatario_id BIGINT NOT NULL,
    direccion_origen TEXT NOT NULL,
    direccion_destino TEXT NOT NULL,
    tipo_envio VARCHAR(20) NOT NULL,
    estado_actual VARCHAR(30) DEFAULT 'REGISTRADO',
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_entrega_estimada DATETIME,
    fecha_entrega_real DATETIME,
    costo DECIMAL(10,2) NOT NULL,
    descuento_aplicado DECIMAL(5,2) DEFAULT 0,
    costo_final DECIMAL(10,2) NOT NULL,
    repartidor_id BIGINT,
    tienda_origen_id BIGINT,
    tienda_destino_id BIGINT,
    intentos_entrega INT DEFAULT 0,
    motivo_devolucion TEXT,
    fecha_devolucion DATETIME,
    prioridad INT DEFAULT 1,
    observaciones TEXT,
    FOREIGN KEY (remitente_id) REFERENCES CLIENTE(id),
    FOREIGN KEY (destinatario_id) REFERENCES CLIENTE(id),
    FOREIGN KEY (repartidor_id) REFERENCES REPARTIDOR_INFO(id),
    FOREIGN KEY (tienda_origen_id) REFERENCES TIENDA(id),
    FOREIGN KEY (tienda_destino_id) REFERENCES TIENDA(id)
);

CREATE TABLE ENVIO_PAQUETE (
    envio_id BIGINT,
    paquete_id BIGINT,
    fecha_agregado DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (envio_id, paquete_id),
    FOREIGN KEY (envio_id) REFERENCES ENVIO(id),
    FOREIGN KEY (paquete_id) REFERENCES PAQUETE(id)
);

CREATE TABLE MOVIMIENTO_RASTREO (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    envio_id BIGINT NOT NULL,
    fecha_movimiento DATETIME DEFAULT CURRENT_TIMESTAMP,
    ubicacion VARCHAR(255) NOT NULL,
    descripcion TEXT,
    estado_anterior VARCHAR(30),
    estado_nuevo VARCHAR(30) NOT NULL,
    empleado_responsable_id BIGINT,
    tienda_id BIGINT,
    FOREIGN KEY (envio_id) REFERENCES ENVIO(id),
    FOREIGN KEY (empleado_responsable_id) REFERENCES EMPLEADO(id),
    FOREIGN KEY (tienda_id) REFERENCES TIENDA(id)
);

CREATE TABLE RUTA (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    codigo_ruta VARCHAR(20) UNIQUE NOT NULL,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    repartidor_id BIGINT NOT NULL,
    origen VARCHAR(255) NOT NULL,
    destino VARCHAR(255) NOT NULL,
    distancia_total DECIMAL(8,2),
    tiempo_estimado_total INT,
    estado VARCHAR(20) DEFAULT 'PLANIFICADA',
    fecha_inicio DATETIME,
    fecha_finalizacion DATETIME,
    observaciones TEXT,
    FOREIGN KEY (repartidor_id) REFERENCES REPARTIDOR_INFO(id)
);

CREATE TABLE DIRECCION_CLIENTE (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    cliente_id BIGINT NOT NULL,
    calle VARCHAR(255) NOT NULL,
    numero VARCHAR(20),
    colonia VARCHAR(100),
    ciudad VARCHAR(100) NOT NULL,
    estado VARCHAR(100) NOT NULL,
    codigo_postal VARCHAR(10) NOT NULL,
    pais VARCHAR(50) DEFAULT 'México',
    referencias TEXT,
    latitud DECIMAL(10,8),
    longitud DECIMAL(11,8),
    tipo_direccion VARCHAR(20) DEFAULT 'RESIDENCIAL',
    principal BOOLEAN DEFAULT FALSE,
    activa BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (cliente_id) REFERENCES CLIENTE(id)
);

CREATE TABLE REPORTE (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tipo_reporte VARCHAR(50) NOT NULL,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT,
    fecha_generacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_inicio DATETIME,
    fecha_fin DATETIME,
    parametros TEXT,
    resultados LONGTEXT,
    generado_por_usuario_id BIGINT,
    formato_salida VARCHAR(20) DEFAULT 'HTML',
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (generado_por_usuario_id) REFERENCES USUARIO(id)
);
